---
title: 'Tipologia i cicle de vida de les dades: PRACTICA2'
author: "Autor: Oriol Toll i Laura Gassó"
date: "May 2022"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 05.584-PAC-header.html
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*****
# Introducció
*****

Aquest projecte pretén posar en pràctica les activitats que es duen a terme en les fases inicials d'un projecte de mineria de dades. Aquestes tenen com a objectiu obtenir un domini de les dades amb les que es construirà el model de mineria. És vital coneixer profundament les dades tant en el seu format com contingut. Tasques típiques poden ser la selecció de característiques o variables, la preparació del joc de dades per a posteriorment ser consumit per un algorisme (tractament de valors nuls i outliers, transformacions, codificació de les variables categòriques, etc) i intentar extreure el màxim coneixement possible de les dades.

Per a la resolució d'aquest projecte es farà ús del dataset de **Titànic** obtingut de la pàgina de kaggle: https://www.kaggle.com/competitions/titanic/data

*****
# Resolució
*****

S'instal·len i es carreguen les llibreries

```{r setup libraries, include=TRUE,  message=FALSE, warning=FALSE}
# Set libraries
library(data.table)
library(tidyr)
# https://cran.r-project.org/web/packages/arules/index.html
if (!require('arules')) install.packages('arules'); library('arules')
# https://cran.r-project.org/web/packages/ggplot2/index.html
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
# https://cran.r-project.org/web/packages/dplyr/index.html
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
if (!require("DT")) install.packages('DT'); library('DT')
if (!require("nortest")) install.packages('nortest'); library('nortest')
```

Es carreguen els fitxers de dades.

```{r import data, echo=TRUE, message=FALSE, warning=FALSE}
# Load data
raw.train <- data.table::fread("./data/train.csv", dec = ".")
raw.test <- data.table::fread("./data/test.csv", dec = ".")
```

## Quina pregunta/problema es pot respondre amb el dataset Titànic?

El dataset Titànic representa informació sobre els passatgers i la tripulació que anava en el Titànic en el moment del naufràgi. A partir de l'anàlisi dels supervivents i els morts en aquest accident, es poden compèndre els critèris i procediments d'evacuació que es van dur a terme en el moment del sinistre.

També es pot utilizar el dataset per tal de crear un algoritme de classificació que ajudia a predir la probabilitat de salvar-se d'un passatger.

## Exploració de les dades i descripció del dataset

S'uneix el joc de dades de train i test per tal de realitzar les tasques de neteja i processament.

```{r , echo=TRUE, message=FALSE, warning=FALSE}
# Get full dataset

# Check if any label on training is missing
if(sum(is.na(raw.train$Survived)) == 0) {

  # Join train and test set  
  test <- raw.test[, Survived := NA]
  total.data <- rbind(raw.train, test)
} else {
  print('There are some missing values in dependant variable on training data set')
}

```

Es verifica l'estructura del joc de dades principal.

```{r}
str(total.data)
```

S'observa que es tenen 1309 registres que corresponen als viatgers i tripulació del Titànic i 11 variables que els caracteritzen.

Es revisa la descripció de les variables contingudes al fitxer i si els tipus de variable es correspon al que s'ha carregat:


**PassengerId**
    integer with the id of the row (one for each passenger)
    
**Survived**
    a factor with two levels (no and yes) specifying whether the person has survived the sinking.

**Pclass**
    factor specifying the class for passengers or the type of service aboard for crew members.
    
**Name**
    string with the name of the passenger.
    
**Sex**
    factor with levels male and female.
    
**Age**
    numeric value with the persons age on the day of the sinking. The age of babies (under 12 months) is given as a fraction of one year (1/month).
    
 **SibSp**
    ordered factor specifying the number if siblings/spouses aboard; adopted from Vanderbild data set.

**Parch**
    an ordered factor specifying the number of parents/children aboard; adopted from Vanderbild data set.

**Ticket**
  string specifying the persons ticket number (NA for crew members).

**Fare**
    numeric value with the ticket price (NA for crew members, musicians and employees of the shipyard company).

**Cabin**
    string specifying the persons cabin
    
**Embarked**
    factor with the persons place of embarkment.


Es canvien a factor les columnes necessaries.

```{r , echo=TRUE, message=FALSE, warning=FALSE}
changeCols <- c('Survived', 'Pclass', 'Sex', 'SibSp', 'Parch')
total.data[,(changeCols):= lapply(.SD, as.factor), .SDcols = changeCols]
```

Es treuen les estadístiques bàsiques.

```{r , echo=TRUE, message=FALSE, warning=FALSE}
# Get data summary 
summary(total.data)
```

 S'observa que els passatgers eren molt joves donat que la mitjana d'edat és 29.88.
 
## Integració i selecció de les dades d’interès a analitzar

Les dades que s'utlitzaran són les que anteriorment s'han ajuntat del data de *test* i el de *train.* Tot i això, no s'estudiaran ni tractaran totes les variables, donat que variables com **PassengerID**, **Name**, **Cabin** o **Ticket**, ens aporten informació que no serà de cap utilitat per resoldre el problema incial.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
work.data <- total.data[,.(Survived, Pclass, Sex, Age, SibSp, Parch, Fare, Embarked)]

```

## Neteja de les dades.

### Estadístiques de valors buits.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
colSums(is.na(work.data))

colSums(work.data=="")
```

Assignem la mitjana per a valors buits de la variable **Age**.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
work.data$Age[is.na(work.data$Age)] <- mean(work.data$Age,na.rm=T)
```

Assignem un valor de **0** al valor buit de la variable **Fare**, ja que correspon al preu del tiquet d'un membre de la tripulació.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
work.data$Fare[is.na(work.data$Fare)] <- 0
```

Assignem valor **Desconegut** per a valors buits de la variable **Embarked**.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
work.data$Embarked[(work.data$Embarked == "")] <- "Desconegut"
```

### Estadístiques de valors extrems.


## Anàlisi de les dades.


Per començar, es farà una representació gràfica per les variables que es volen analitzar, d'aquesta manera, es podrà tenir una idea principal de com es comporten totes elles: 


### Visualització dades numèriques

```{r, echo=TRUE, message=FALSE, warning=FALSE}
work.data$Fare_log <- -log(work.data$Fare)

meltData <- melt(work.data[, .(Age, Fare, Fare_log)])
p <- ggplot(meltData, aes(factor(variable), value)) 
p + geom_boxplot() + facet_wrap(~variable, scale="free")
```

En el boxplot sense transformar de la variable Fare, no es pot apreciar res a causa de les observacions amb
valors elevats. Es procedeix per tant a aplicar el logaritme a la variable per tal de poder visualitzar millor els resultats.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
hist(work.data$Age)
hist(work.data$Fare)

ggplot(work.data) +
    geom_histogram(aes(x = Age), bins = 35)
```

A partir de l'histograma s'observa com cap de les variables numèriques tenen una distribució normal.
En les dos apareix una cua llarga a la dreta.


### Visualització dades categòriques

* *Survived:*

```{r, echo=TRUE, message=FALSE, warning=FALSE}
qplot(work.data$Survived,
      geom="bar",
      xlab = "Survived")
```

* *Pclass:*

```{r, echo=TRUE, message=FALSE, warning=FALSE}
qplot(work.data$Pclass,
      geom="bar",
      xlab = "Pclass")
```

* *Sex:*

```{r, echo=TRUE, message=FALSE, warning=FALSE}
qplot(work.data$Sex,
      geom="bar",
      xlab = "Sex")
```

* *Embarked:*

```{r, echo=TRUE, message=FALSE, warning=FALSE}
qplot(work.data$Embarked,
      geom="bar",
      xlab = "Embarked")
```


* *SibSp:*

```{r, echo=TRUE, message=FALSE, warning=FALSE}
qplot(work.data$SibSp,
      geom="bar",
      xlab = "SibSp")
```

* *Parch:*

```{r, echo=TRUE, message=FALSE, warning=FALSE}
qplot(work.data$Parch,
      geom="bar",
      xlab = "Parch")
```


### Selecció dels grups de dades que es volen analitzar/comparar 

Un cop netejat el dataset, es torna a dividir en train i test per tal de realitzar els anàlisis.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
work.train <- work.data[!is.na(Survived)]
work.test <- work.data[is.na(Survived)]
```

A partir d'aqui es procedeix a anàlitzar si els factors classe i genere són rellevants per a la supervivència.

Es procedeix a analitzar les relacions entre les diferents variables del joc de dades per veure si es relacionen i com.

Es visualitza la relació entre les variables "sex" i "survived":

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(work.train) +
   geom_bar(aes(Sex, fill = Survived), position = "fill") +
   ggtitle("Relació entre les variables sex i survived")
```

Es visualitza la relació entre les variables "pclass" i "survived":

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(work.train) +
   geom_bar(aes(Pclass, fill = Survived), position = "fill") +
   ggtitle("Relació entre les variables class i survived")
```

Tal i com es pot observar ene els gràfics si que sembla que hi hagi una correlació entre la classe o el genere i el fet de sobreviure. A priori sembla que les dones i les classes altes tenen un rati de supervivència més elevat.

### Comprovació de la normalitat i homogeneïtat de la variància. **[Proves sobre les 7 variables d'estudi, si no són normals, les normalitzem?]**

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# #Gràfics
# par(mfrow=c(1,3))
# hist(work.train$Age) # histograma
# qqnorm(work.train$Age) # gràfic quantile
# qqline(work.train$Age)
# #costrast normalitat
# nortest::lillie.test(work.train$Age) #contrast
```

### Aplicació de proves estadístiques per comparar els grups de dades **[Proves amb el raw.train sobre Survived]**

```{r, echo=TRUE, message=FALSE, warning=FALSE}

```



## Conclusions 

```{r, echo=TRUE, message=FALSE, warning=FALSE}

```


## Taula de contribucions


```{r,  echo=FALSE, message=FALSE, warning=FALSE}
contributions <- data.table::data.table(Contribucions = c('Investigació previa', 'Redacció  de les respostes', 'Desenvolupament del codi'),
                                        Firma = rep(c('Oriol Toll, Laura Gassó'),3))

DT::datatable(contributions)
```









